# 并发

## 内存间交互

一个变量如何从主内存拷贝到工作内存,工作内存如何同步到主内存

1. lock(锁定)
    - 作用于主内存变量
    - 把变量表示为一条线程独占
2. unlock(解锁)
    - 作用于主内存变量
    - 释放被锁定的变量

3. read(读取)
    - 作用于主内存变量
    - 将变量从主内存中传输到线程的工作内存中

4. load(载入)
    - 作用于工作内存变量
    - 把read出来的值,放入工作内存的副本中

5. use(使用)
    - 作用于工作内存变量
    - 将工作内存中的变量传递给执行引擎

6. assign(赋值)
    - 作用于工作内存变量
    - 把从执行引擎接收到的值赋值给工作内存变量

7. store(存储)
    - 作用于工作内存
    - 将工作内存中一个变量的值传送到住内存,等待write操作

8. write(写)
    - 作用于主内存
    - 把store操作从工作内存中得到的变量值放入主内存中

8种操作时必须满足以下规则  

1. 不允许`read`和`load`,`store`和`write`操作单独出现

2. 不允许一个线程丢弃它的`assign`操作,工作内存改变必须同步回主内存

3. 不允许一个线程无原因的把数据从工作内存同步回主内存

4. 一个新的变量只能在主内存中诞生,不允许在工作内存中直接使用一个未初始化的变量

5. 一个变量在同一时刻只允许一条线程对其进行`lock`操作,但`lock`操作可以被同一个条线程重复执行多次(需要执行相同次数的`unlock`)

6. 如果对一个变量执行lock操作,那将清空工作内存中此变量的值,在执行引擎使用前需要使用重新执行`load`和`assign`操作

7. 一个变量没有被`lock`操作,不允许执行`unlock`操作

8. 对一个变量执行`unlock`操作之前,必须把此变量同步回主内存(执行`store`,`write`)

## volatile关键字

轻量级同步机制

修饰变量后,该变量将具备两种特性

1. 可见性
   - 当一个线程修改该变量时,新值对其他线程来说是立刻得知的
   - java中运算并不是原子操作,(也就是同步时可能不一致)

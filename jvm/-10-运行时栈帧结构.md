# 运行时栈帧结构

每个方法调用的过程都应用虚拟机一个栈帧入栈到出栈的过程  
只有位于栈顶的栈帧有效,也成为当前栈

- 栈帧构成
  - 局部变量表
  - 操作栈
  - 动态链接
  - 返回地址

## 局部变量表

一组变量值存储空间,用于存放方法参数和方法内定义的局部变量(编译为`class文件时,在方法的`Code`属性的`max_locals`数据项表示局部变量表分配的最大容量)  
  
  局部变量表的容量以`Variable Solot`为最小单位

## 操作数栈

后入先出栈(编译为`class文件时,在方法的`Code`属性的`max_stacks`数据项表示局部变量表分配的最大深度)  
每个元素可以是任意的java数据类型(32位数据类型占用栈容量1,64位为2)

## 动态链接

每个栈帧都包含一个运行时常量池中该栈帧的引用所属方法的引用(为了支持动态链接)  
常量池中指向方法的符号引用会在类加载阶段或第一次使用的时候就转换为直接引用,这一过程称为***静态解析***  
另一部分将在每一次运行期间转化为直接引用***动态链接***

## 方法返回地址

方法开始执行后,只有两种方式可以退出

1. 正常完成出口
   - 执行引擎遇到任意一个方法返回的字节码指令
   - 调用者的`PC计数器`作为返回地址
2. 异常完成出口
   - 异常在方法体内没有得到处理(异常包括虚拟机产生的异常,athrow字节码产生的异常)

## 静态分派

依赖静态类型来定位方法执行版本的分派动作  
发生在编译阶段
典型应用为方法重载
多分派

## 动态类型

运行期根据实际类型确定方法执行版本的分派过程  
发生在运行期
典型应用重写
单分派

## MethodHandle/Reflection

Reflection 是在java代码层面的调用
MethodHandle 是在字节码层次的调用